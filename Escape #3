<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三扇门</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }

        .scene {
            position: fixed;
            width: 100vw;
            height: 100vh;
            perspective: 1200px;
            perspective-origin: 50% 50%;
        }

        .room-box {
            position: absolute;
            width: 1000px;
            height: 600px;
            left: 50%;
            top: 50%;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%) translateZ(300px) rotateX(-10deg) rotateY(0deg);
            transition: transform 0.1s ease-out;
        }

        /* 房间的六个面 */
        .room-face {
            position: absolute;
            backface-visibility: hidden;
        }

        /* 后墙 */
        .back {
            width: 1000px;
            height: 600px;
            background: #c4b454;
            transform: translateZ(-500px);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.2);
        }

        /* 地板 */
        .floor {
            width: 1000px;
            height: 1002px;
            background: #c4b454;
            transform: translateY(100px) rotateX(90deg);
            transform-origin: center center;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.3);
        }

        .floor::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 98px,
                    rgba(0,0,0,0.1) 98px,
                    rgba(0,0,0,0.1) 100px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 98px,
                    rgba(0,0,0,0.1) 98px,
                    rgba(0,0,0,0.1) 100px
                );
        }

        /* 天花板 */
        .ceiling {
            width: 1000px;
            height: 1002px;
            background: #c4b454;
            transform: translateY(-500px) rotateX(-90deg);
            transform-origin: center center;
            box-shadow: inset 0 0 120px rgba(0,0,0,0.3);
        }

        /* 左墙 */
        .left {
            width: 1002px;
            height: 600px;
            background: #c4b454;
            transform: translateX(-500px) rotateY(90deg);
            transform-origin: center center;
            box-shadow: inset -80px 0 100px rgba(0,0,0,0.25);
        }

        /* 右墙 */
        .right {
            width: 1002px;
            height: 600px;
            background: #c4b454;
            transform: translateX(500px) rotateY(-90deg);
            transform-origin: center center;
            box-shadow: inset 80px 0 100px rgba(0,0,0,0.25);
        }

        /* 前墙（摄像机这边，不显示） */
        .front {
            width: 1000px;
            height: 600px;
            background: rgba(196, 180, 84, 0.1);
            transform: translateZ(500px);
        }

        /* 门容器 */
        .doors-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 120px;
            transform: translateZ(2px);
            padding-bottom: 0px;
            z-index: 100;
        }

        /* 门 */
        .door {
            width: 220px;
            height: 400px;
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 20%, #1a1a1a 50%, #0a0a0a 80%, #000000 100%);
            border: 3px solid #000;
            box-shadow:
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 2px 10px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 2px;
            transform-style: preserve-3d;
            transform-origin: left center;
            z-index: 1;
        }

        /* 门把手 */
        .door::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #1a1a1a;
            border: 1px solid #000;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: 
                inset 0 1px 2px rgba(255,255,255,0.1),
                0 1px 3px rgba(0,0,0,0.5);
        }

        .door:hover {
            transform: scale(1.05);
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 2px 15px rgba(0,0,0,0.5),
                0 0 30px rgba(200,180,80,0.2);
        }

        .door:active {
            transform: scale(0.98);
        }

        /* 环境光 */
        .ambient-light {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                ellipse at 50% 20%, 
                rgba(220, 200, 100, 0.2) 0%, 
                rgba(180, 160, 70, 0.1) 30%,
                transparent 60%
            );
            pointer-events: none !important;
            transform: translateZ(1px);
            animation: pulse 5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* 噪点纹理 */
        .noise {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            opacity: 0.06;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" /></filter><rect width="100%" height="100%" filter="url(%23noise)" /></svg>');
            z-index: 100;
        }

        /* 昏暗遮罩 */
        .vignette {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            background: radial-gradient(
                circle at center,
                transparent 20%,
                rgba(0,0,0,0.4) 70%,
                rgba(0,0,0,0.7) 100%
            );
            z-index: 99;
        }

        /* 眼动追踪提示 */
        .eye-tracking-info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #c4b454;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-family: monospace;
        }

        .eye-tracking-info.ready {
            color: #4ade80;
        }

        /* 隐藏webgazer的默认视频预览 */
        #webgazerVideoFeed {
            display: none !important;
        }

        #webgazerFaceOverlay {
            display: none !important;
        }

        #webgazerFaceFeedbackBox {
            display: none !important;
        }

        /* 眼动追踪光标 */
        .gaze-cursor {
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s;
            opacity: 0;
        }

        .gaze-cursor.active {
            opacity: 1;
        }

        /* 光标外圈 */
        .gaze-cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border: 2px solid #c4b454;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(196, 180, 84, 0.5);
        }

        /* 光标中心点 */
        .gaze-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #c4b454;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(196, 180, 84, 0.8);
        }

        /* 停留进度环 */
        .gaze-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .gaze-progress svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .gaze-progress circle {
            fill: none;
            stroke: #4ade80;
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.1s linear;
        }

        /* 视野遮罩 - z-index 比门低 */
        .darkness-overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            z-index: 500;
            background: radial-gradient(
                circle 150px at 50% 50%,
                transparent 0%,
                rgba(0, 0, 0, 0.2) 30%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.95) 100%
            );
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="scene">
        <div class="room-box">
            <!-- 房间的六个面 -->
            <div class="room-face back">
                <!-- 三扇门 - 放回3D场景中 -->
                <div class="doors-container">
                    <div class="door" data-door="1"></div>
                    <div class="door" data-door="2"></div>
                    <div class="door" data-door="3"></div>
                </div>

                <!-- 环境光 -->
                <div class="ambient-light"></div>
            </div>
            <div class="room-face floor"></div>
            <div class="room-face ceiling"></div>
            <div class="room-face left"></div>
            <div class="room-face right"></div>
            <div class="room-face front"></div>
        </div>
    </div>
    
    <!-- 特效 -->
    <div class="noise"></div>
    <div class="vignette"></div>

    <!-- 眼动追踪UI -->
    <div class="eye-tracking-info" id="eyeTrackingInfo">眼动追踪: 初始化中...</div>
    <div class="gaze-cursor" id="gazeCursor">
        <div class="gaze-progress">
            <svg viewBox="0 0 40 40">
                <circle cx="20" cy="20" r="17" id="progressCircle"></circle>
            </svg>
        </div>
    </div>

    <!-- 视野遮罩层 - z-index 比门低 -->
    <div class="darkness-overlay" id="darknessOverlay"></div>

    <script>
        // 获取元素
        const doors = document.querySelectorAll('.door');
        const roomBox = document.querySelector('.room-box');
        const eyeTrackingInfo = document.getElementById('eyeTrackingInfo');
        const gazeCursor = document.getElementById('gazeCursor');
        const darknessOverlay = document.getElementById('darknessOverlay');
        const progressCircle = document.getElementById('progressCircle');

        // 设置进度环的初始状态
        const circumference = 2 * Math.PI * 17;
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = circumference;
        
        // 游戏状态
        let doorStates = ['closed', 'closed', 'closed'];
        let doorContents = [];

        // 停留检测状态
        let gazeStartTime = null;
        let currentGazedDoor = null;
        const GAZE_DURATION = 3000; // 3秒

        // 初始化游戏
        function initGame() {
            const safeIndex = Math.floor(Math.random() * 3);
            doorContents = [0, 1, 2].map(i => i === safeIndex ? 'safe' : 'danger');
            console.log('游戏初始化，安全门索引:', safeIndex);
        }
        initGame();

        // 检测光标是否在门上
        function getDoorAtPosition(x, y) {
            for (let i = 0; i < doors.length; i++) {
                const door = doors[i];
                const rect = door.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return i;
                }
            }
            return null;
        }

        // 更新停留进度
        function updateGazeProgress(progress) {
            const offset = circumference - (progress * circumference);
            progressCircle.style.strokeDashoffset = offset;
        }

        // 重置停留进度
        function resetGazeProgress() {
            progressCircle.style.strokeDashoffset = circumference;
            gazeStartTime = null;
            currentGazedDoor = null;
        }
        
        // 眼动追踪状态
        let eyeTrackingEnabled = false;
        let useMouseFallback = true;
        
        // 平滑滤波队列 - 增加窗口大小提升稳定性
        const smoothingWindow = 15;
        let gazeHistory = [];
        
        function smoothGazeData(x, y) {
            gazeHistory.push({ x, y });
            if (gazeHistory.length > smoothingWindow) {
                gazeHistory.shift();
            }
            let totalWeight = 0;
            let smoothX = 0;
            let smoothY = 0;
            gazeHistory.forEach((point, index) => {
                const weight = index + 1;
                smoothX += point.x * weight;
                smoothY += point.y * weight;
                totalWeight += weight;
            });
            return {
                x: smoothX / totalWeight,
                y: smoothY / totalWeight
            };
        }
        
        // 更新视野遮罩位置（更新背景渐变位置）
        function updateViewMask(x, y) {
            const xPercent = (x / window.innerWidth) * 100;
            const yPercent = (y / window.innerHeight) * 100;
            darknessOverlay.style.background = `radial-gradient(
                circle 150px at ${xPercent}% ${yPercent}%,
                transparent 0%,
                rgba(0, 0, 0, 0.2) 30%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.95) 100%
            )`;
        }

        // 处理停留在门上的逻辑
        function handleDoorGaze(x, y) {
            const doorIndex = getDoorAtPosition(x, y);

            if (doorIndex !== null && doorStates[doorIndex] !== 'open') {
                // 光标在门上
                if (currentGazedDoor !== doorIndex) {
                    // 切换到新的门，重置计时
                    resetGazeProgress();
                    currentGazedDoor = doorIndex;
                    gazeStartTime = Date.now();
                    console.log('开始注视门:', doorIndex + 1);
                } else {
                    // 继续注视同一扇门
                    const elapsed = Date.now() - gazeStartTime;
                    const progress = Math.min(elapsed / GAZE_DURATION, 1);
                    updateGazeProgress(progress);

                    if (elapsed >= GAZE_DURATION) {
                        // 停留满3秒，触发门的打开
                        resetGazeProgress();
                        triggerDoor(doorIndex);
                    }
                }
            } else {
                // 光标不在门上，重置
                if (currentGazedDoor !== null) {
                    console.log('离开门');
                    resetGazeProgress();
                }
            }
        }

        // 触发门的打开/进入逻辑
        function triggerDoor(doorIndex) {
            const door = doors[doorIndex];

            if (doorStates[doorIndex] === 'closed') {
                // 第一次触发：门半开，显示门后的内容
                doorStates[doorIndex] = 'half-open';
                console.log('门半开，内容:', doorContents[doorIndex]);

                door.style.transform = 'rotateY(-45deg)';
                door.style.transformOrigin = 'left center';
                door.style.transition = 'all 0.5s ease-out';

                // 根据门后内容显示不同效果
                if (doorContents[doorIndex] === 'danger') {
                    // 危险门：显示恐怖的眼睛
                    showEye(door);
                } else {
                    // 安全门：显示黑暗空洞（什么都没有）
                    showDarkness(door);
                }

                // 添加提示文字
                const hint = document.createElement('div');
                hint.style.cssText = `
                    position: fixed;
                    bottom: 30px;
                    left: 50%;
                    transform: translateX(-50%);
                    color: #c4b454;
                    font-size: 18px;
                    background: rgba(0,0,0,0.8);
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    animation: fadeIn 0.3s ease-out;
                `;
                hint.textContent = '继续注视门可进入';
                hint.id = 'doorHint';

                // 移除旧提示
                const oldHint = document.getElementById('doorHint');
                if (oldHint) oldHint.remove();

                document.body.appendChild(hint);

            } else if (doorStates[doorIndex] === 'half-open') {
                // 第二次触发：进入门后
                doorStates[doorIndex] = 'open';
                console.log('进入门，内容:', doorContents[doorIndex]);

                // 移除提示
                const hint = document.getElementById('doorHint');
                if (hint) hint.remove();

                // 门完全打开并放大
                door.style.transform = 'scale(2) rotateY(-90deg)';
                door.style.opacity = '0';
                door.style.transition = 'all 0.8s ease-out';

                // 根据门后内容决定结局
                setTimeout(() => {
                    if (doorContents[doorIndex] === 'safe') {
                        // 安全门：通关
                        showVictory();
                    } else {
                        // 危险门：被怪物吃掉，游戏结束
                        showGameOver();
                    }
                }, 800);
            }
        }
        
        // 显示恐怖的眼睛（危险门）
        function showEye(doorElement) {
            const eyeContainer = document.createElement('div');
            eyeContainer.style.cssText = `
                position: absolute;
                top: 50%;
                left: 130%;
                transform: translate(-50%, -50%);
                width: 80px;
                height: 80px;
                z-index: 10;
            `;

            // 外层光晕
            const glow = document.createElement('div');
            glow.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 120px;
                height: 120px;
                background: radial-gradient(circle, rgba(255, 0, 0, 0.4) 0%, transparent 70%);
                border-radius: 50%;
                animation: glowPulse 2s ease-in-out infinite;
            `;

            // 眼球
            const eye = document.createElement('div');
            eye.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80px;
                height: 80px;
                background: radial-gradient(circle at 40% 40%, #ff3333 0%, #ff0000 20%, #cc0000 40%, #8b0000 60%, #000 100%);
                border-radius: 50%;
                box-shadow:
                    0 0 40px rgba(255, 0, 0, 0.9),
                    inset -5px -5px 15px rgba(0, 0, 0, 0.5),
                    inset 3px 3px 10px rgba(255, 50, 50, 0.3);
                animation: eyeBlink 4s ease-in-out infinite;
            `;

            // 瞳孔
            const pupil = document.createElement('div');
            pupil.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 28px;
                height: 28px;
                background: radial-gradient(circle, #000 0%, #1a0000 100%);
                border-radius: 50%;
                box-shadow:
                    inset 0 0 8px rgba(0, 0, 0, 0.9),
                    0 0 10px rgba(0, 0, 0, 0.8);
                animation: pupilDilate 3s ease-in-out infinite;
            `;

            // 高光
            const highlight = document.createElement('div');
            highlight.style.cssText = `
                position: absolute;
                top: 30%;
                left: 35%;
                width: 15px;
                height: 15px;
                background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
                border-radius: 50%;
                animation: eyeBlink 4s ease-in-out infinite;
            `;

            eye.appendChild(pupil);
            eye.appendChild(highlight);
            eyeContainer.appendChild(glow);
            eyeContainer.appendChild(eye);

            const style = document.createElement('style');
            style.textContent = `
                @keyframes eyeBlink {
                    0%, 100% { transform: translate(-50%, -50%) scaleY(1); }
                    3%, 7% { transform: translate(-50%, -50%) scaleY(0.05); }
                }

                @keyframes glowPulse {
                    0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
                    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
                }

                @keyframes pupilDilate {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.2); }
                }
            `;
            if (!document.getElementById('eyeAnimations')) {
                style.id = 'eyeAnimations';
                document.head.appendChild(style);
            }

            doorElement.appendChild(eyeContainer);
        }

        // 显示黑暗空洞（安全门 - 什么都没有）
        function showDarkness(doorElement) {
            const darknessContainer = document.createElement('div');
            darknessContainer.style.cssText = `
                position: absolute;
                top: 50%;
                left: 130%;
                transform: translate(-50%, -50%);
                width: 120px;
                height: 200px;
                z-index: 10;
            `;

            // 深邃的黑暗
            const darkness = document.createElement('div');
            darkness.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100%;
                height: 100%;
                background: radial-gradient(ellipse at center,
                    #0a0a0a 0%,
                    #000000 30%,
                    #000000 70%,
                    transparent 100%);
                border-radius: 10px;
                box-shadow:
                    inset 0 0 30px rgba(0, 0, 0, 0.9),
                    inset 0 0 50px rgba(0, 0, 0, 0.7),
                    0 0 20px rgba(0, 0, 0, 0.5);
                animation: darknessBreathing 3s ease-in-out infinite;
            `;

            // 微弱的深度感
            const innerDarkness = document.createElement('div');
            innerDarkness.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 60%;
                height: 70%;
                background: #000000;
                border-radius: 8px;
                box-shadow:
                    inset 0 0 40px rgba(0, 0, 0, 1),
                    0 0 10px rgba(0, 0, 0, 0.8);
            `;

            darkness.appendChild(innerDarkness);
            darknessContainer.appendChild(darkness);

            const style = document.createElement('style');
            style.textContent = `
                @keyframes darknessBreathing {
                    0%, 100% { opacity: 0.9; }
                    50% { opacity: 1; }
                }
            `;
            if (!document.getElementById('darknessAnimations')) {
                style.id = 'darknessAnimations';
                document.head.appendChild(style);
            }

            doorElement.appendChild(darknessContainer);
        }

        // 胜利画面
        function showVictory() {
            const screen = document.createElement('div');
            screen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 100, 0, 0.95);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            screen.innerHTML = `
                <div style="color: #4ade80; font-size: 72px; font-weight: bold;">通关！</div>
                <div style="color: #fff; font-size: 24px; margin-top: 20px;">你选择了正确的门</div>
                <button onclick="location.reload()" style="
                    margin-top: 40px;
                    padding: 15px 40px;
                    font-size: 20px;
                    background: #4ade80;
                    color: #000;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                ">重新开始</button>
            `;
            document.body.appendChild(screen);
        }
        
        // 游戏结束画面
        function showGameOver() {
            const screen = document.createElement('div');
            screen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(100, 0, 0, 0.95);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            screen.innerHTML = `
                <div style="color: #ff0000; font-size: 72px; font-weight: bold;">GAME OVER</div>
                <div style="color: #fff; font-size: 24px; margin-top: 20px;">你被门后的怪物吃掉了</div>
                <button onclick="location.reload()" style="
                    margin-top: 40px;
                    padding: 15px 40px;
                    font-size: 20px;
                    background: #ff0000;
                    color: #fff;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                ">重新开始</button>
            `;
            document.body.appendChild(screen);
        }

        // 视角控制
        let targetX = 0;
        let targetY = -10;
        let currentX = 0;
        let currentY = -10;
        
        document.addEventListener('mousemove', (e) => {
            if (useMouseFallback) {
                targetX = (e.clientX / window.innerWidth - 0.5) * 15;
                targetY = -10 + (e.clientY / window.innerHeight - 0.5) * 10;

                // 更新视野遮罩位置（鼠标模式）
                updateViewMask(e.clientX, e.clientY);

                // 同步更新眼动光标位置
                gazeCursor.style.left = e.clientX + 'px';
                gazeCursor.style.top = e.clientY + 'px';

                // 处理停留在门上的逻辑
                handleDoorGaze(e.clientX, e.clientY);
            }
        });

        // 初始化眼动追踪
        async function initEyeTracking() {
            try {
                eyeTrackingInfo.textContent = '眼动追踪: 正在请求摄像头权限...';
                
                await webgazer.setGazeListener((data, timestamp) => {
                    if (data == null) return;

                    const smoothed = smoothGazeData(data.x, data.y);
                    const gazeX = smoothed.x;
                    const gazeY = smoothed.y;

                    gazeCursor.style.left = gazeX + 'px';
                    gazeCursor.style.top = gazeY + 'px';

                    updateViewMask(gazeX, gazeY);

                    targetX = (gazeX / window.innerWidth - 0.5) * 15;
                    targetY = -10 + (gazeY / window.innerHeight - 0.5) * 10;

                    // 处理停留在门上的逻辑
                    handleDoorGaze(gazeX, gazeY);

                    eyeTrackingEnabled = true;
                    useMouseFallback = false;
                }).begin();
                
                // 优化追踪配置
                webgazer.showVideoPreview(false)
                    .showPredictionPoints(false)
                    .applyKalmanFilter(true); // 启用卡尔曼滤波器提升稳定性

                // 使用ridge回归算法，效果更稳定
                webgazer.setRegression('ridge');

                // 保存校准数据，提升长期使用体验
                webgazer.params.saveDataAcrossSessions = true;

                // 增加采样频率，提升响应速度
                webgazer.params.videoViewerWidth = 320;
                webgazer.params.videoViewerHeight = 240;

                // 初始化完成提示
                setTimeout(() => {
                    eyeTrackingInfo.textContent = '眼动追踪: 已启用 ✓';
                    eyeTrackingInfo.classList.add('ready');
                    gazeCursor.classList.add('active');
                }, 3000);
                
            } catch (error) {
                console.error('眼动追踪初始化失败:', error);
                eyeTrackingInfo.textContent = '眼动追踪: 初始化失败';
                useMouseFallback = true;
                gazeCursor.classList.remove('active');
            }
        }

        // 动画循环
        function animate() {
            currentX += (targetX - currentX) * 0.05;
            currentY += (targetY - currentY) * 0.05;
            roomBox.style.transform = `translate(-50%, -50%) translateZ(300px) rotateX(${currentY}deg) rotateY(${currentX}deg)`;
            requestAnimationFrame(animate);
        }
        
        animate();

        // 初始化视野遮罩（居中）
        updateViewMask(window.innerWidth / 2, window.innerHeight / 2);

        // 在鼠标模式下也显示光标
        gazeCursor.classList.add('active');
        
        // 初始化眼动追踪
        window.addEventListener('load', () => {
            setTimeout(() => {
                initEyeTracking();
            }, 1000);
        });
    </script>
</body>
</html>
