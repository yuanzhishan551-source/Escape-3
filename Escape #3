<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三扇门</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            font-family: Arial, sans-serif;
            background: #000;
        }

        .scene {
            position: fixed;
            width: 100vw;
            height: 100vh;
            perspective: 1200px;
            perspective-origin: 50% 50%;
        }

        .room-box {
            position: absolute;
            width: 1000px;
            height: 600px;
            left: 50%;
            top: 50%;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%) translateZ(300px) rotateX(-10deg) rotateY(0deg);
            transition: transform 0.1s ease-out;
        }

        /* 房间的六个面 */
        .room-face {
            position: absolute;
            backface-visibility: hidden;
        }

        /* 后墙 */
        .back {
            width: 1000px;
            height: 600px;
            background: #c4b454;
            transform: translateZ(-500px);
            box-shadow: inset 0 0 100px rgba(0,0,0,0.2);
        }

        /* 地板 */
        .floor {
            width: 1000px;
            height: 1002px;
            background: #c4b454;
            transform: translateY(100px) rotateX(90deg);
            transform-origin: center center;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.3);
        }

        .floor::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 98px,
                    rgba(0,0,0,0.1) 98px,
                    rgba(0,0,0,0.1) 100px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 98px,
                    rgba(0,0,0,0.1) 98px,
                    rgba(0,0,0,0.1) 100px
                );
        }

        /* 天花板 */
        .ceiling {
            width: 1000px;
            height: 1002px;
            background: #c4b454;
            transform: translateY(-500px) rotateX(-90deg);
            transform-origin: center center;
            box-shadow: inset 0 0 120px rgba(0,0,0,0.3);
        }

        /* 左墙 */
        .left {
            width: 1002px;
            height: 600px;
            background: #c4b454;
            transform: translateX(-500px) rotateY(90deg);
            transform-origin: center center;
            box-shadow: inset -80px 0 100px rgba(0,0,0,0.25);
        }

        /* 右墙 */
        .right {
            width: 1002px;
            height: 600px;
            background: #c4b454;
            transform: translateX(500px) rotateY(-90deg);
            transform-origin: center center;
            box-shadow: inset 80px 0 100px rgba(0,0,0,0.25);
        }

        /* 前墙（摄像机这边，不显示） */
        .front {
            width: 1000px;
            height: 600px;
            background: rgba(196, 180, 84, 0.1);
            transform: translateZ(500px);
        }

        /* 门容器 */
        .doors-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 120px;
            transform: translateZ(1px);
            padding-bottom: 0px;
            z-index: 200;
        }

        /* 门 */
        .door {
            width: 220px;
            height: 400px;
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 20%, #1a1a1a 50%, #0a0a0a 80%, #000000 100%);
            border: 3px solid #000;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.3),
                inset 0 2px 10px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 2px;
            transform-style: preserve-3d;
            transform-origin: left center;
            z-index: 1;
        }

        /* 门把手 */
        .door::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 20px;
            width: 12px;
            height: 12px;
            background: #1a1a1a;
            border: 1px solid #000;
            border-radius: 50%;
            transform: translateY(-50%);
            box-shadow: 
                inset 0 1px 2px rgba(255,255,255,0.1),
                0 1px 3px rgba(0,0,0,0.5);
        }

        .door:hover {
            transform: scale(1.05);
            box-shadow: 
                0 8px 20px rgba(0,0,0,0.4),
                inset 0 2px 15px rgba(0,0,0,0.5),
                0 0 30px rgba(200,180,80,0.2);
        }

        .door:active {
            transform: scale(0.98);
        }

        /* 环境光 */
        .ambient-light {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(
                ellipse at 50% 20%, 
                rgba(220, 200, 100, 0.2) 0%, 
                rgba(180, 160, 70, 0.1) 30%,
                transparent 60%
            );
            pointer-events: none !important;
            transform: translateZ(1px);
            animation: pulse 5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        /* 噪点纹理 */
        .noise {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            opacity: 0.06;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" /></filter><rect width="100%" height="100%" filter="url(%23noise)" /></svg>');
            z-index: 100;
        }

        /* 昏暗遮罩 */
        .vignette {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            background: radial-gradient(
                circle at center,
                transparent 20%,
                rgba(0,0,0,0.4) 70%,
                rgba(0,0,0,0.7) 100%
            );
            z-index: 99;
        }

        /* 眼动追踪提示 */
        .eye-tracking-info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: #c4b454;
            font-size: 14px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-family: monospace;
        }

        .eye-tracking-info.ready {
            color: #4ade80;
        }

        /* 隐藏webgazer的默认视频预览 */
        #webgazerVideoFeed {
            display: none !important;
        }

        #webgazerFaceOverlay {
            display: none !important;
        }

        #webgazerFaceFeedbackBox {
            display: none !important;
        }

        /* 眼动追踪光标 */
        .gaze-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 2px solid #c4b454;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transform: translate(-50%, -50%);
            transition: opacity 0.3s;
            opacity: 0;
            box-shadow: 
                0 0 10px rgba(196, 180, 84, 0.5),
                inset 0 0 5px rgba(196, 180, 84, 0.3);
        }

        .gaze-cursor.active {
            opacity: 1;
        }

        .gaze-cursor::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: #c4b454;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(196, 180, 84, 0.8);
        }

        /* 黑幕遮罩 */
        .darkness-overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none !important;
            z-index: 98;
            background: radial-gradient(
                circle 150px at 50% 50%,
                transparent 0%,
                rgba(0, 0, 0, 0.2) 30%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.95) 100%
            );
            opacity: 0;
            transition: opacity 0.5s;
        }

        .darkness-overlay.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="scene">
        <div class="room-box">
            <!-- 房间的六个面 -->
            <div class="room-face back">
                <!-- 三扇门 -->
                <div class="doors-container">
                    <div class="door" data-door="1"></div>
                    <div class="door" data-door="2"></div>
                    <div class="door" data-door="3"></div>
                </div>
                
                <!-- 环境光 -->
                <div class="ambient-light"></div>
            </div>
            <div class="room-face floor"></div>
            <div class="room-face ceiling"></div>
            <div class="room-face left"></div>
            <div class="room-face right"></div>
            <div class="room-face front"></div>
        </div>
    </div>
    
    <!-- 特效 -->
    <div class="noise"></div>
    <div class="vignette"></div>

    <!-- 眼动追踪UI -->
    <div class="eye-tracking-info" id="eyeTrackingInfo">眼动追踪: 初始化中...</div>
    <div class="gaze-cursor" id="gazeCursor"></div>
    <div class="darkness-overlay" id="darknessOverlay"></div>

    <script>
        // 获取元素
        const doors = document.querySelectorAll('.door');
        const roomBox = document.querySelector('.room-box');
        const eyeTrackingInfo = document.getElementById('eyeTrackingInfo');
        const gazeCursor = document.getElementById('gazeCursor');
        const darknessOverlay = document.getElementById('darknessOverlay');
        
        // 游戏状态
        let doorStates = ['closed', 'closed', 'closed'];
        let doorContents = [];
        
        // 初始化游戏
        function initGame() {
            const safeIndex = Math.floor(Math.random() * 3);
            doorContents = [0, 1, 2].map(i => i === safeIndex ? 'safe' : 'danger');
            console.log('游戏初始化，安全门索引:', safeIndex);
        }
        initGame();
        
        // 眼动追踪状态
        let eyeTrackingEnabled = false;
        let useMouseFallback = true;
        
        // 平滑滤波队列
        const smoothingWindow = 5;
        let gazeHistory = [];
        
        function smoothGazeData(x, y) {
            gazeHistory.push({ x, y });
            if (gazeHistory.length > smoothingWindow) {
                gazeHistory.shift();
            }
            let totalWeight = 0;
            let smoothX = 0;
            let smoothY = 0;
            gazeHistory.forEach((point, index) => {
                const weight = index + 1;
                smoothX += point.x * weight;
                smoothY += point.y * weight;
                totalWeight += weight;
            });
            return {
                x: smoothX / totalWeight,
                y: smoothY / totalWeight
            };
        }
        
        // 更新黑幕位置
        function updateDarknessOverlay(x, y) {
            const xPercent = (x / window.innerWidth) * 100;
            const yPercent = (y / window.innerHeight) * 100;
            darknessOverlay.style.background = `radial-gradient(
                circle 150px at ${xPercent}% ${yPercent}%,
                transparent 0%,
                rgba(0, 0, 0, 0.2) 30%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.95) 100%
            )`;
        }

        // 门的点击事件
        doors.forEach((door, index) => {
            door.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('门被点击！门号:', index + 1);
                
                const doorIndex = parseInt(this.getAttribute('data-door')) - 1;
                
                if (doorStates[doorIndex] === 'closed') {
                    // 第一次点击：门半开
                    doorStates[doorIndex] = 'half-open';
                    console.log('门半开，内容:', doorContents[doorIndex]);
                    
                    this.style.transform = 'rotateY(-30deg)';
                    this.style.transformOrigin = 'left center';
                    this.style.transition = 'all 0.5s ease-out';
                    
                    // 显示眼睛
                    if (doorContents[doorIndex] === 'danger') {
                        showEye(this);
                    }
                    
                } else if (doorStates[doorIndex] === 'half-open') {
                    // 第二次点击：进入门
                    doorStates[doorIndex] = 'open';
                    console.log('进入门');
                    
                    this.style.transform = 'scale(1.3) rotateY(-60deg)';
                    this.style.opacity = '0';
                    this.style.transition = 'all 0.8s ease-out';
                    
                    setTimeout(() => {
                        if (doorContents[doorIndex] === 'safe') {
                            showVictory();
                        } else {
                            showGameOver();
                        }
                    }, 800);
                }
            }, true);
            
            door.addEventListener('mouseenter', function() {
                console.log('鼠标进入门:', index + 1);
            });
        });
        
        // 显示眼睛
        function showEye(doorElement) {
            const eye = document.createElement('div');
            eye.style.cssText = `
                position: absolute;
                top: 50%;
                left: 130%;
                transform: translate(-50%, -50%);
                width: 60px;
                height: 60px;
                background: radial-gradient(circle, #ff0000 20%, #8b0000 50%, #000 100%);
                border-radius: 50%;
                box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
                animation: eyeBlink 3s ease-in-out infinite;
                z-index: 10;
            `;
            
            const pupil = document.createElement('div');
            pupil.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 20px;
                height: 20px;
                background: #000;
                border-radius: 50%;
            `;
            eye.appendChild(pupil);
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes eyeBlink {
                    0%, 100% { transform: translate(-50%, -50%) scaleY(1); }
                    5%, 10% { transform: translate(-50%, -50%) scaleY(0.1); }
                }
            `;
            document.head.appendChild(style);
            
            doorElement.appendChild(eye);
        }
        
        // 胜利画面
        function showVictory() {
            const screen = document.createElement('div');
            screen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 100, 0, 0.95);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            screen.innerHTML = `
                <div style="color: #4ade80; font-size: 72px; font-weight: bold;">通关！</div>
                <div style="color: #fff; font-size: 24px; margin-top: 20px;">你选择了正确的门</div>
                <button onclick="location.reload()" style="
                    margin-top: 40px;
                    padding: 15px 40px;
                    font-size: 20px;
                    background: #4ade80;
                    color: #000;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                ">重新开始</button>
            `;
            document.body.appendChild(screen);
        }
        
        // 游戏结束画面
        function showGameOver() {
            const screen = document.createElement('div');
            screen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(100, 0, 0, 0.95);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            screen.innerHTML = `
                <div style="color: #ff0000; font-size: 72px; font-weight: bold;">GAME OVER</div>
                <div style="color: #fff; font-size: 24px; margin-top: 20px;">你被门后的怪物吃掉了</div>
                <button onclick="location.reload()" style="
                    margin-top: 40px;
                    padding: 15px 40px;
                    font-size: 20px;
                    background: #ff0000;
                    color: #fff;
                    border: none;
                    border-radius: 10px;
                    cursor: pointer;
                    font-weight: bold;
                ">重新开始</button>
            `;
            document.body.appendChild(screen);
        }

        // 视角控制
        let targetX = 0;
        let targetY = -10;
        let currentX = 0;
        let currentY = -10;
        
        document.addEventListener('mousemove', (e) => {
            if (useMouseFallback) {
                targetX = (e.clientX / window.innerWidth - 0.5) * 15;
                targetY = -10 + (e.clientY / window.innerHeight - 0.5) * 10;
            }
        });

        // 初始化眼动追踪
        async function initEyeTracking() {
            try {
                eyeTrackingInfo.textContent = '眼动追踪: 正在请求摄像头权限...';
                
                await webgazer.setGazeListener((data, timestamp) => {
                    if (data == null) return;
                    
                    const smoothed = smoothGazeData(data.x, data.y);
                    const gazeX = smoothed.x;
                    const gazeY = smoothed.y;
                    
                    gazeCursor.style.left = gazeX + 'px';
                    gazeCursor.style.top = gazeY + 'px';
                    
                    updateDarknessOverlay(gazeX, gazeY);
                    
                    targetX = (gazeX / window.innerWidth - 0.5) * 15;
                    targetY = -10 + (gazeY / window.innerHeight - 0.5) * 10;
                    
                    eyeTrackingEnabled = true;
                    useMouseFallback = false;
                }).begin();
                
                webgazer.showVideoPreview(false)
                    .showPredictionPoints(false)
                    .applyKalmanFilter(false);
                
                webgazer.setRegression('ridge');
                webgazer.params.saveDataAcrossSessions = true;
                
                setTimeout(() => {
                    eyeTrackingInfo.textContent = '眼动追踪: 已启用 ✓';
                    eyeTrackingInfo.classList.add('ready');
                    gazeCursor.classList.add('active');
                    darknessOverlay.classList.add('active');
                }, 3000);
                
            } catch (error) {
                console.error('眼动追踪初始化失败:', error);
                eyeTrackingInfo.textContent = '眼动追踪: 初始化失败';
                useMouseFallback = true;
                gazeCursor.classList.remove('active');
            }
        }

        // 动画循环
        function animate() {
            currentX += (targetX - currentX) * 0.05;
            currentY += (targetY - currentY) * 0.05;
            roomBox.style.transform = `translate(-50%, -50%) translateZ(300px) rotateX(${currentY}deg) rotateY(${currentX}deg)`;
            requestAnimationFrame(animate);
        }
        
        animate();
        
        // 立即显示黑幕
        darknessOverlay.classList.add('active');
        updateDarknessOverlay(window.innerWidth / 2, window.innerHeight / 2);
        
        // 初始化眼动追踪
        window.addEventListener('load', () => {
            setTimeout(() => {
                initEyeTracking();
            }, 1000);
        });
    </script>
</body>
</html>
